<!DOCTYPE html>
<html>
<head>
    <title>PortfolioItem-BulkStateChanger</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"piTypePicker",padding:"10px"},{xtype:"container",itemId:"gridContainer",padding:"10px"}],_portfolioItemTypes:{},_portfolioItemOrdinalsByTypePath:{},_portfolioItemComboBox:null,_typeFeature:null,_portfolioItemGrid:null,_selectedPortfolioItemOrdinal:null,launch:function(){this._getPITypes()},_getPITypes:function(){var me=this,piDataStore=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,fetch:!0,listeners:{scope:this,load:me._PITypeStoreLoaded},filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"}]})},_PITypeStoreLoaded:function(store,records){var me=this;Ext.Array.each(records,function(piTypeRecord){var ordinal=piTypeRecord.get("Ordinal");-1!=ordinal&&(me._portfolioItemTypes[piTypeRecord.get("Name")]=piTypeRecord.get("TypePath"),me._portfolioItemOrdinalsByTypePath[piTypeRecord.get("TypePath")]=ordinal)}),this._typeFeature=records[0].get("TypePath").toLowerCase(),this._buildUI()},_buildUI:function(){var me=this,data=[];Ext.iterate(me._portfolioItemTypes,function(name,typePath){data.push({name:name,type:typePath})});var artifactTypesStore=Ext.create("Ext.data.Store",{fields:["name","type"],data:data});me._portfolioTypeCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose PortfolioItem Type",store:artifactTypesStore,queryMode:"local",displayField:"name",valueField:"type",listeners:{scope:this,select:me._getPortfolioItems}}),me.down("#piTypePicker").add(me._portfolioTypeCombobox)},_getPortfolioItems:function(){var selectedPortfolioItemType=this._portfolioTypeCombobox.getValue();this._selectedPortfolioItemOrdinal=this._portfolioItemOrdinalsByTypePath[selectedPortfolioItemType],this._portfolioItemGrid&&this._portfolioItemGrid.destroy(),this._portfolioItemGrid=this.down("#gridContainer").add({xtype:"rallygrid",itemId:"rallygrid",columnCfgs:["FormattedID","Name","State"],context:this.getContext(),enableBulkEdit:!0,showRowActionsColumn:!0,storeConfig:{model:selectedPortfolioItemType}})}});
                Ext.override(Rally.ui.menu.bulk.RecordMenu,{items:[{xtype:"rallyrecordmenuitembulkportfolioitemstate"}]}),Ext.override(Rally.ui.menu.bulk.MenuItem,{successfulRecordsDueToNoChange:[],successfulRecords:[],dataToUpdate:[],saveRecords:function(records,args){var me=this;me.successfulRecords=[],me.successfulRecordsDueToNoChange=[],me.dataToUpdate=[];var hydratedRecords=[],promises=[];Ext.Array.each(records,function(artifact){promises.push(me.hydrateArtifact(artifact,me))}),Deft.Promise.all(promises).then({success:function(hydratedRecords){var successfulRecords=me.prepareRecords(hydratedRecords,args);if(me.successfulRecordsDueToNoChange=successfulRecords,me.successfulRecordsDueToNoChange.length===records.length)me.onSuccess(me.successfulRecordsDueToNoChange,[],args);else{var selectedState=args,selectedStateRef=selectedState.get("_ref"),updateState="";""!==selectedStateRef&&(updateState={_ref:selectedStateRef}),me.dataToUpdate=_.difference(hydratedRecords,me.successfulRecordsDueToNoChange),Rally.data.BulkRecordUpdater.updateRecords({records:me.dataToUpdate,propertiesToUpdate:{State:updateState},success:function(failedRecords){var successfulUpdateRecords=_.difference(me.dataToUpdate,failedRecords),unsuccessfulRecords=failedRecords;me.successfulRecords=me.successfulRecordsDueToNoChange.concat(successfulUpdateRecords),0!==me.successfulRecords.length?me.onSuccess(me.successfulRecords,unsuccessfulRecords,args,"successful update"):(Rally.ui.notify.Notifier.showError({message:"No updates succeeded."}),Ext.callback(me.onActionComplete,null,[me.successfulRecords,unsuccessfulRecords]))},scope:me})}}})},hydrateArtifact:function(artifact,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,artifactType=artifact.get("_type"),artifactOid=artifact.get("ObjectID"),artifactModel=Rally.data.ModelFactory.getModel({type:artifactType,scope:me,success:function(model,operation){model.load(artifactOid,{scope:me,success:function(artifactHydrated,operation){deferred.resolve(artifactHydrated)}})}});return deferred}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PortfolioItemBulkStateChanger.RecordMenuItemPortfolioItemState",{extend:"Rally.ui.menu.bulk.MenuItem",alias:"widget.rallyrecordmenuitembulkportfolioitemstate",clientMetrics:[{beginMethod:"_onStateSelect",endMethod:"onSuccess",description:"bulk action complete"}],config:{text:"Choose State...",handler:function(){this._onBulkStateClicked()},predicate:function(records){return _.every(records,function(record){return record.self.isArtifact()})},prepareRecords:function(records,selectedState){var me=this,successfulRecords=[],newStateRef=selectedState.get("_ref")||"";return _.each(records,function(record){record.beginEdit();var existingState=record.get("State"),existingStateRef="";existingState&&(existingStateRef=Rally.util.Ref.getRelativeUri(existingState._ref)),_.isEqual(existingStateRef,newStateRef)?(console.log("New State = Existing State"),successfulRecords.push(record),record.cancelEdit()):""===newStateRef?record.set("State",newStateRef):record.set("State",{_ref:newStateRef})}),successfulRecords},callingScope:this},constructor:function(config){this.mergeConfig(config),this.callParent(arguments)},_onBulkStateClicked:function(){Ext.create("PortfolioItemBulkStateChanger.PortfolioItemStateChooserDialog",{autoShow:!0,records:this.records,title:"BULK PORTFOLIOITEM STATE EDIT",listeners:{stateselected:this._onStateSelected,scope:this}})},_onStateSelected:function(dialog,selectedState){this.onBeforeAction(this.records)!==!1&&this.saveRecords(this.records,selectedState)},onSuccess:function(successfulRecords,unsuccessfulRecords,selectedState,errorMessage){var message=["State updated for",successfulRecords.length,1===successfulRecords.length?"item":"items"].join(" ");successfulRecords.length===this.records.length?Rally.ui.notify.Notifier.show({message:message+"."}):Rally.ui.notify.Notifier.showWarning({message:[message,", but ",unsuccessfulRecords.length," failed: ",errorMessage].join(" ")});var changes={};changes.State=selectedState._ref,Ext.callback(this.onActionComplete,null,[successfulRecords,unsuccessfulRecords,changes]),this.records=null}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PortfolioItemBulkStateChanger.PortfolioItemStateChooserDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.portfolioitemstatechooserdialog",requires:["Rally.ui.Button","Rally.ui.dialog.Dialog","Rally.ui.TextField"],width:350,closable:!0,autoShow:!0,cls:"rally-confirm-dialog",title:"",message:"",confirmLabel:"Apply",cancelLabel:"Cancel",_portfolioItemStateCombobox:null,_portfolioItemStateStore:null,_selectedState:null,_portfolioItemRecords:null,items:[{xtype:"component",itemId:"confirmMsg",cls:"confirmMessage"},{xtype:"container",itemId:"portfolioItemStateComboboxContainer"}],dockedItems:[{xtype:"toolbar",dock:"bottom",padding:"10",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",cls:"confirm primary small",itemId:"confirmButton",userAction:"clicked yes in dialog"},{xtype:"rallybutton",cls:"cancel secondary small",itemId:"cancelButton",ui:"link"}]}],constructor:function(config){var me=this;this.callParent(arguments),this.autoCenter&&(this.scrollListener.saveScrollPosition=!0),this.records&&(this._portfolioItemRecords=this.records);var selectedPortfolioItemType=me._portfolioItemRecords[0].get("_type"),piTypeDefStore=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,fetch:!0,listeners:{scope:this,load:me._getPortfolioItemAttributeDefs},filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"TypePath",operator:"=",value:selectedPortfolioItemType}]})},initComponent:function(){var me=this;this.callParent(arguments),this.addEvents("stateselected","cancel"),this.down("#confirmButton").hide(),this.down("#cancelButton").hide()},_getPortfolioItemAttributeDefs:function(store,records){var me=this,attributeDefCollection=records[0].getCollection("Attributes").load({fetch:!0,callback:function(records,operation,success){me._hydrateAttributeDefCollection(records,operation,success)},scope:me})},_hydrateAttributeDefCollection:function(records,operation,success){var me=this;Ext.Array.each(records,function(attribute){var attributeName=attribute.get("Name");if("State"===attributeName)var attributeTypeCollection=attribute.getCollection("AllowedValues").load({fetch:!0,callback:function(records,operation,success){me._hydratePortfolioItemStates(records,operation,success)},scope:me})})},_hydratePortfolioItemStates:function(records,operation,success){var me=this,piStateData=[];Ext.Array.each(records,function(allowedValue){var stringValue=allowedValue.get("StringValue"),name=stringValue,stateRecord={};""===stringValue?(stateRecord.Name="No Entry",stateRecord.StringValue="",stateRecord._ref=""):(stateRecord.Name=name,stateRecord.StringValue=allowedValue.get("StringValue"),stateRecord._ref=allowedValue.get("_ref")),piStateData.push(stateRecord)}),me._portfolioItemStateStore=Ext.create("Ext.data.Store",{fields:["Name","StringValue","_ref"],data:piStateData}),me._buildUI()},_buildUI:function(){var me=this;this.down("#confirmButton").on("click",this._onConfirm,this),this.down("#confirmButton").setText(this.confirmLabel),this.down("#cancelButton").on("click",this._onCancel,this),this.down("#cancelButton").setText(this.cancelLabel),this.message?this.down("#confirmMsg").update(this.message):this.down("#confirmMsg").hide(),me._portfolioItemStateCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose State:",store:me._portfolioItemStateStore,queryMode:"local",displayField:"Name",valueField:"_ref",minWidth:500,listeners:{scope:this,select:me._selectPortfolioItemState}}),this.down("#portfolioItemStateComboboxContainer").add(me._portfolioItemStateCombobox),this.down("#confirmButton").show(),this.down("#cancelButton").show()},_selectPortfolioItemState:function(combobox,records){var me=this;me._selectedState=records[0]},show:function(){this.autoCenter&&this._saveScrollPosition(),this.callParent(arguments)},close:function(){this._onCancel()},_onConfirm:function(){this.fireEvent("stateselected",this,this._selectedState),this.destroy()},_onCancel:function(){this.fireEvent("cancel",this),this.destroy()},_saveScrollPosition:function(){this.savedScrollPosition={xOffset:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,yOffset:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}}})})();

            Rally.launchApp('CustomApp', {
                name:"PortfolioItem-BulkStateChanger",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
